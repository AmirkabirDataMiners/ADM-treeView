/*
* Demo: http://amirkabirdataminers.github.io/ADM-treeView
*
* @version 1.0.0
*
* Â© 2016 Amirkabir Data Miners <info@adm-co.net> - www.adm-co.net
*/

!function(n){"use strict";Array.prototype.loop=function(n,t){for(var e=this.length;e--;){var i=this.length-e-1,o=t?e-1+1:i;if(n(this[o],i)===!1)break}};var t=function(n,t){for(var e=n,i=t.split(/[.]/g);!i[0]&&i.length;)i.shift();return i.loop(function(n){return void 0!==e&&void(e=e[n])}),e},e=function(n,e,i){if(!(n&&n instanceof Array&&n.length))return-1;if(i){for(var o=0,r=n.length;o<r;o++){var c=t(n[o],i),s=t(e,i);if(c==s)return o}return-1}return n.indexOf(e)},i=function(t){return!("object"!=typeof t||!n.isFunction(t.then))},o=function(){return function(n,t,e){t.bind("keydown keypress",function(t){13===t.which&&(n.$apply(function(){n.$eval(e.teEnter)}),t.preventDefault())})}},r=function(n){return function(t,e,i,o){i.$observe("teFocus",function(i){t.$applyAsync(function(){("string"==typeof i&&7==i.length&&"#"==i.substr(0,1)||t.$eval(i))&&n(function(){e[0].focus()},100)})})}},c=function(n){return function(t,e,i){i.$observe("teTemplate",function(i){t.$applyAsync(function(){e.html(i),n(e.contents())(t)})})}},s=function(t){return{scope:!0,link:function(e,i,o){var r=n.isDefined(o.small)?" small":"",c=n.element('<span class="te-loading disable'+r+'" ng-hide="!loading"><svg class="te-i noI te-i-spin" viewBox="0 0 24 24"><use xlink:href="#te-i-autorenew" /></svg></span>');i.append(c),e.$applyAsync(function(){t(c)(e),setTimeout(function(){c.removeClass("disable")},100)}),o.$observe("teLoading",function(n){e.$evalAsync(function(){e.$eval(n)?e.loading=!0:e.loading=!1})})}}},a=function(){var t={childName:"childs",title:"$item.title",kidType:"",selectable:!1,readOnly:!1,trackBy:"",maxDepth:9999,direction:"ltr",dictionary:{noItem:"No item!",titlePlaceholder:"Title ...",rootAddBtn:"Add item",confirmBtn:"Confirm",cancelBtn:"Cancel"}},e={getOptions:function(n){var e=n&&t[n]||t;return e}};this.setConfigs=function(e,i){return i?void(t[e]=n.extend(t[e]||{},i)):(e.dictionary=n.extend(t.dictionary,e.dictionary||{}),void n.extend(t,e))},this.$get=function(){return e}},d=function(o,r,c,s){return{scope:{configs:"=",selected:"=?"},require:"ngModel",templateUrl:"/src/ADM-treeView.html",link:function(r,s,a,d){r.options=n.extend({},o.getOptions(),r.configs||{}),r.options.dictionary=n.extend({},o.getOptions().dictionary,r.configs.dictionary||{}),r.options.trackBy=r.options.trackBy.replace("$item.",""),r.options.readOnly=r.options.readOnly||r.options.selectable,r.ctrl={model:[],selected:[]},r.$chn=r.options.childName,r.grabTitle=function(n){var e=r.options.title.replace("$item.","");return t(n,e)};var l=function(n,t){for(var e={},i=t.replace("$item.",""),o=i.split(/[.]/g);!o[0]&&o.length;)o.shift();return o.loop(function(t,i){var o={};n=i?e:n,o[t]=n,e=o},!0),e};r.depthValid=function(n){return n<r.options.maxDepth},r.canBeOpen=function(n,t){return(!r.options.readOnly||r.options.readOnly&&n[r.$chn]&&n[r.$chn].length)&&r.depthValid(t)},r.canShowKidContent=function(n,t){return(n.kidContent||n.kidContentLoading)&&(!t[r.$chn]||t[r.$chn]&&!t[r.$chn].length)};var u=function(n,t){r.$applyAsync(function(){n.kidContent=t,n.kidContentLoading=!1})};r.kidOpen=function(n,t){r.$applyAsync(function(){if(t.kidContent)t.kidContent="",t.kidContentLoading=!1;else if(r.options.onKidOpen){var e=r.options.onKidOpen(n);i(e)?(t.kidContentLoading=!0,c.when(e).then(function(n){u(t,n)})):"string"==typeof e&&u(t,e)}})};var p=function(n,t){n.push(t),v()};r.add=function(t,e,o){if(e.newItem.replace(/ /g,"")){t instanceof Array||(t=[]);var s=l(e.newItem,r.options.title),a=n.copy(o.node);if(a&&a[r.$chn].push(s),r.options.onAdd){var d=r.options.onAdd(a,s,e.newItem);i(d)?c.when(d).then(function(e){e&&p(t,n.extend({},s,e===!0?{}:e))}):d!==!1&&p(t,s)}else p(t,s);e.add=!1,e.newItem=""}};var f=function(t,e){n.extend(t,l(e.editItem,r.options.title)),v()};r.edit=function(t,e,o,s,a){a&&a.stopPropagation(),e.edit=!1;var d=n.extend(n.copy(t),l(e.editItem,r.options.title)),u=n.copy(o.$parent.node);if(u&&(u[r.$chn][s]=d),r.options.onEdit){var p=r.options.onEdit(d,u);i(p)?c.when(p).then(function(n){n&&f(t,e)}):p!==!1&&f(t,e)}else f(t,e)},r.cancelEdit=function(n,t){t&&t.stopPropagation(),n.edit=!1};var h=function(n){1==n.$depth?r.ctrl.model.splice(n.$index,1):n.$parent.node[r.$chn].splice(n.$index,1),v()};r.delete=function(t,e,o){t.deleteConfirm=!1;var s,a=n.copy(e.$parent.node);if(s=a?a[r.$chn].splice(e.$index,1)[0]:r.ctrl.model[e.$index],r.options.onDelete){var d=r.options.onDelete(s,a);i(d)?c.when(d).then(function(n){n&&h(e)}):d!==!1&&h(e)}else h(e)},r.initItem=function(n){n[r.options.childName]=n[r.options.childName]||[]},r.toggle=function(n,t){t&&t.stopPropagation(),r.selected||(r.selected=[]);var i=e(r.selected,n,r.options.trackBy);return i>-1?r.selected.splice(i,1):r.selected.push(n)},r.exists=function(n){return e(r.selected,n,r.options.trackBy)>-1};var v=function(n){r.$evalAsync(function(){r.ctrl.model=n||r.ctrl.model,d.$setViewValue(r.ctrl.model),d.$render()})},g=function(n){return n?(v(n),n):n};d.$formatters.push(g)}}},l=function(n){n.setConfigs({isDeviceTouch:"ontouchstart"in window||navigator.maxTouchPoints})};return n.module("ADM-treeView",[]).constant("constants",{}).provider("ADMtrv",a).directive("teFocus",["$timeout",r]).directive("teEnter",[o]).directive("teTemplate",["$compile",c]).directive("teLoading",["$compile",s]).directive("admTrv",["ADMtrv","constants","$q","$http",d]).config(["ADMtrvProvider",l])}(window.angular);